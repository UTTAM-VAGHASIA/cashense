# Database Schema

This document outlines the database schema for Cashense, implemented in PostgreSQL via Supabase.

## Core Tables

### users
Stores user profile information.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key, generated by Supabase Auth          |
| email                | text        | User's email address                             |
| full_name            | text        | User's full name                                 |
| avatar_url           | text        | URL to user's profile image                      |
| phone_number         | text        | User's phone number                              |
| country              | text        | User's country                                   |
| currency             | text        | User's preferred currency (default: INR)         |
| date_format          | text        | User's preferred date format                     |
| created_at           | timestamp   | Account creation timestamp                       |
| updated_at           | timestamp   | Last update timestamp                            |
| last_active          | timestamp   | Last activity timestamp                          |
| notification_settings| jsonb       | User's notification preferences                  |
| theme_preference     | text        | User's UI theme preference                       |
| onboarding_completed | boolean     | Whether user completed onboarding                |

### workspaces
Independent financial spaces for different contexts (personal, business, etc.)

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| name                 | text        | Workspace name                                   |
| description          | text        | Workspace description                            |
| owner_id             | uuid        | Foreign key to users.id                          |
| icon                 | text        | Icon identifier                                  |
| color                | text        | Color theme                                      |
| created_at           | timestamp   | Creation timestamp                               |
| updated_at           | timestamp   | Last update timestamp                            |
| is_default           | boolean     | Whether this is the user's default workspace     |
| settings             | jsonb       | Workspace-specific settings                      |

### workspace_members
Maps users to workspaces with permissions.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| workspace_id         | uuid        | Foreign key to workspaces.id                     |
| user_id              | uuid        | Foreign key to users.id                          |
| role                 | text        | Role: owner, admin, member, viewer               |
| joined_at            | timestamp   | When user joined the workspace                   |
| invite_status        | text        | Status: pending, accepted, rejected              |
| invite_email         | text        | Email for pending invites                        |

### accounts
Financial accounts (bank accounts, wallets, cash, etc.)

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| workspace_id         | uuid        | Foreign key to workspaces.id                     |
| name                 | text        | Account name                                     |
| type                 | text        | Type: bank, cash, wallet, credit, investment     |
| sub_type             | text        | Optional subtype                                 |
| currency             | text        | Account currency                                 |
| balance              | decimal     | Current balance                                  |
| parent_account_id    | uuid        | Foreign key to accounts.id (for sub-accounts)    |
| icon                 | text        | Icon identifier                                  |
| color                | text        | Color identifier                                 |
| is_excluded          | boolean     | Whether excluded from totals                     |
| created_at           | timestamp   | Creation timestamp                               |
| updated_at           | timestamp   | Last update timestamp                            |
| created_by           | uuid        | Foreign key to users.id                          |
| account_number       | text        | Last 4 digits of account number (optional)       |
| notes                | text        | Additional notes                                 |
| is_archived          | boolean     | Whether account is archived                      |

### account_balances
Historical account balances for tracking over time.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| account_id           | uuid        | Foreign key to accounts.id                       |
| balance              | decimal     | Balance at time                                  |
| as_of_date           | date        | Date of this balance                             |
| created_at           | timestamp   | Creation timestamp                               |

### cash_denominations
Tracks physical cash denominations for cash accounts.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| account_id           | uuid        | Foreign key to accounts.id                       |
| denomination_value   | int         | Value of denomination (e.g., 100, 500, 2000)     |
| currency             | text        | Currency code                                    |
| count                | int         | Number of bills/coins                            |
| updated_at           | timestamp   | Last update timestamp                            |

### categories
Transaction categories.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| workspace_id         | uuid        | Foreign key to workspaces.id                     |
| name                 | text        | Category name                                    |
| icon                 | text        | Icon identifier                                  |
| color                | text        | Color identifier                                 |
| parent_category_id   | uuid        | Foreign key to categories.id (for sub-categories)|
| type                 | text        | Type: income, expense, transfer                  |
| is_system            | boolean     | Whether it's a system category                   |
| created_at           | timestamp   | Creation timestamp                               |
| created_by           | uuid        | Foreign key to users.id                          |
| is_archived          | boolean     | Whether category is archived                     |

### transactions
Financial transactions.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| workspace_id         | uuid        | Foreign key to workspaces.id                     |
| amount               | decimal     | Transaction amount                               |
| currency             | text        | Transaction currency                             |
| type                 | text        | Type: income, expense, transfer                  |
| category_id          | uuid        | Foreign key to categories.id                     |
| account_id           | uuid        | Foreign key to accounts.id (source account)      |
| destination_account_id| uuid       | For transfers: target account                    |
| date                 | date        | Transaction date                                 |
| time                 | time        | Transaction time                                 |
| description          | text        | Transaction description                          |
| notes                | text        | Additional notes                                 |
| created_at           | timestamp   | Creation timestamp                               |
| updated_at           | timestamp   | Last update timestamp                            |
| created_by           | uuid        | Foreign key to users.id                          |
| location             | text        | Optional location                                |
| tags                 | text[]      | Array of tags                                    |
| receipt_url          | text        | URL to receipt image                             |
| is_reconciled        | boolean     | Whether transaction is reconciled                |
| recurring_transaction_id| uuid     | Link to recurring transaction template if any    |
| group_id             | uuid        | Foreign key to groups.id if a group expense      |
| is_synced            | boolean     | Whether synced with external source              |
| external_id          | text        | ID from external source (bank import)            |

### recurring_transactions
Templates for recurring transactions.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| workspace_id         | uuid        | Foreign key to workspaces.id                     |
| title                | text        | Recurring transaction title                      |
| amount               | decimal     | Transaction amount                               |
| currency             | text        | Transaction currency                             |
| type                 | text        | Type: income, expense, transfer                  |
| category_id          | uuid        | Foreign key to categories.id                     |
| account_id           | uuid        | Foreign key to accounts.id                       |
| destination_account_id| uuid       | For transfers                                    |
| frequency            | text        | daily, weekly, monthly, yearly, custom           |
| interval             | int         | Interval number (every 2 weeks, etc.)            |
| start_date           | date        | Start date                                       |
| end_date             | date        | End date (optional)                              |
| next_date            | date        | Next occurrence date                             |
| day_of_month         | int         | For monthly: day of month                        |
| day_of_week          | int         | For weekly: day of week                          |
| week_of_month        | int         | For monthly: week of month (1st, 2nd, etc.)      |
| month_of_year        | int         | For yearly: month                                |
| description          | text        | Description template                             |
| is_active            | boolean     | Whether active                                   |
| created_at           | timestamp   | Creation timestamp                               |
| created_by           | uuid        | Foreign key to users.id                          |
| last_generated       | date        | Last date a transaction was generated            |

### subscriptions
Subscription tracking.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| workspace_id         | uuid        | Foreign key to workspaces.id                     |
| name                 | text        | Subscription name                                |
| amount               | decimal     | Subscription amount                              |
| currency             | text        | Currency code                                    |
| billing_cycle        | text        | monthly, yearly, quarterly, etc.                 |
| category_id          | uuid        | Foreign key to categories.id                     |
| account_id           | uuid        | Foreign key to accounts.id                       |
| start_date           | date        | Subscription start date                          |
| next_billing_date    | date        | Next billing date                                |
| reminder_days        | int         | Days before to remind                            |
| notes                | text        | Additional notes                                 |
| created_at           | timestamp   | Creation timestamp                               |
| created_by           | uuid        | Foreign key to users.id                          |
| is_active            | boolean     | Whether subscription is active                   |
| service_provider     | text        | Service provider name                            |
| website              | text        | Provider website                                 |
| logo_url             | text        | Provider logo URL                                |
| recurring_transaction_id| uuid     | Link to recurring transaction if automated       |

## Budget and Goals

### budgets
Budget definitions.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| workspace_id         | uuid        | Foreign key to workspaces.id                     |
| name                 | text        | Budget name                                      |
| amount               | decimal     | Budget amount                                    |
| currency             | text        | Currency code                                    |
| period               | text        | monthly, yearly, custom                          |
| start_date           | date        | Start date                                       |
| end_date             | date        | End date                                         |
| reset_frequency      | text        | monthly, yearly, never                           |
| category_id          | uuid        | Foreign key to categories.id (null for overall)  |
| is_active            | boolean     | Whether budget is active                         |
| created_at           | timestamp   | Creation timestamp                               |
| created_by           | uuid        | Foreign key to users.id                          |
| rollover             | boolean     | Whether unused amounts roll over                 |
| alert_threshold      | int         | Alert at percentage (e.g., 80)                   |

### budget_expenses
Maps transactions to budgets for tracking.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| budget_id            | uuid        | Foreign key to budgets.id                        |
| transaction_id       | uuid        | Foreign key to transactions.id                   |
| amount               | decimal     | Amount counted towards budget                    |
| created_at           | timestamp   | Creation timestamp                               |

### savings_goals
Financial goals.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| workspace_id         | uuid        | Foreign key to workspaces.id                     |
| name                 | text        | Goal name                                        |
| target_amount        | decimal     | Target amount                                    |
| currency             | text        | Currency code                                    |
| current_amount       | decimal     | Current saved amount                             |
| start_date           | date        | Start date                                       |
| target_date          | date        | Target completion date                           |
| account_id           | uuid        | Foreign key to accounts.id (optional)            |
| icon                 | text        | Icon identifier                                  |
| color                | text        | Color identifier                                 |
| notes                | text        | Additional notes                                 |
| created_at           | timestamp   | Creation timestamp                               |
| created_by           | uuid        | Foreign key to users.id                          |
| is_completed         | boolean     | Whether goal is completed                        |
| completed_at         | timestamp   | Completion timestamp                             |
| category             | text        | Goal category (e.g., Travel, Education)          |
| recommended_monthly  | decimal     | Recommended monthly contribution                 |

### goal_contributions
Contributions to savings goals.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| goal_id              | uuid        | Foreign key to savings_goals.id                  |
| transaction_id       | uuid        | Foreign key to transactions.id (optional)        |
| amount               | decimal     | Contribution amount                              |
| date                 | date        | Contribution date                                |
| notes                | text        | Additional notes                                 |
| created_at           | timestamp   | Creation timestamp                               |
| created_by           | uuid        | Foreign key to users.id                          |

## Group Finance

### groups
Groups for shared expenses.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| workspace_id         | uuid        | Foreign key to workspaces.id                     |
| name                 | text        | Group name                                       |
| description          | text        | Group description                                |
| created_at           | timestamp   | Creation timestamp                               |
| created_by           | uuid        | Foreign key to users.id                          |
| icon                 | text        | Icon identifier                                  |
| color                | text        | Color identifier                                 |
| is_active            | boolean     | Whether group is active                          |
| default_split_method | text        | equal, percentage, custom                        |

### group_members
Members of expense groups.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| group_id             | uuid        | Foreign key to groups.id                         |
| user_id              | uuid        | Foreign key to users.id                          |
| name                 | text        | For non-app users: display name                  |
| email                | text        | For non-app users: email                         |
| phone                | text        | For non-app users: phone                         |
| joined_at            | timestamp   | When member joined                               |
| role                 | text        | Role: admin, member                              |
| is_active            | boolean     | Whether member is active                         |
| default_percentage   | decimal     | Default percentage for splits                    |

### group_expenses
Expenses shared within groups.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| group_id             | uuid        | Foreign key to groups.id                         |
| transaction_id       | uuid        | Foreign key to transactions.id                   |
| paid_by              | uuid        | Foreign key to group_members.id                  |
| amount               | decimal     | Total expense amount                             |
| currency             | text        | Currency code                                    |
| date                 | date        | Expense date                                     |
| description          | text        | Expense description                              |
| split_method         | text        | equal, percentage, custom                        |
| category_id          | uuid        | Foreign key to categories.id                     |
| notes                | text        | Additional notes                                 |
| created_at           | timestamp   | Creation timestamp                               |
| created_by           | uuid        | Foreign key to users.id                          |
| receipt_url          | text        | URL to receipt image                             |
| is_settled           | boolean     | Whether fully settled                            |

### expense_shares
Individual shares of group expenses.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| group_expense_id     | uuid        | Foreign key to group_expenses.id                 |
| member_id            | uuid        | Foreign key to group_members.id                  |
| amount               | decimal     | Share amount                                     |
| percentage           | decimal     | Percentage of total (for percentage splits)      |
| is_paid              | boolean     | Whether this share is paid                       |
| settled_at           | timestamp   | When share was settled                           |
| settlement_transaction_id| uuid    | Transaction for settlement if any                |
| created_at           | timestamp   | Creation timestamp                               |

### debt_records
Tracks money owed between users.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| workspace_id         | uuid        | Foreign key to workspaces.id                     |
| lender_id            | uuid        | Foreign key to users.id (who lent)               |
| borrower_id          | uuid        | Foreign key to users.id (who borrowed)           |
| amount               | decimal     | Amount owed                                      |
| currency             | text        | Currency code                                    |
| description          | text        | Description                                      |
| date                 | date        | Date borrowed                                    |
| due_date             | date        | Date due (optional)                              |
| is_settled           | boolean     | Whether settled                                  |
| settled_at           | timestamp   | Settlement timestamp                             |
| settlement_transaction_id| uuid    | Transaction for settlement if any                |
| group_id             | uuid        | Foreign key to groups.id (optional)              |
| created_at           | timestamp   | Creation timestamp                               |
| created_by           | uuid        | Foreign key to users.id                          |
| notes                | text        | Additional notes                                 |
| reminder_enabled     | boolean     | Whether reminders are enabled                    |
| reminder_frequency   | text        | weekly, monthly, custom                          |
| is_reflected_in_balance| boolean   | Whether reflected in account balances            |

## AI and Settings

### ai_transaction_templates
Templates for AI to recognize recurring transactions.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| workspace_id         | uuid        | Foreign key to workspaces.id                     |
| pattern              | text        | Text pattern                                     |
| category_id          | uuid        | Foreign key to categories.id                     |
| confidence           | decimal     | AI confidence score                              |
| created_at           | timestamp   | Creation timestamp                               |
| updated_at           | timestamp   | Last update timestamp                            |
| usage_count          | int         | How many times pattern was used                  |
| last_used            | timestamp   | When pattern was last used                       |

### user_preferences
User-specific app settings.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| user_id              | uuid        | Foreign key to users.id                          |
| key                  | text        | Preference key                                   |
| value                | jsonb       | Preference value                                 |
| updated_at           | timestamp   | Last update timestamp                            |

### notifications
User notifications.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| user_id              | uuid        | Foreign key to users.id                          |
| title                | text        | Notification title                               |
| body                 | text        | Notification body                                |
| type                 | text        | Type: budget, goal, debt, system                 |
| is_read              | boolean     | Whether notification is read                     |
| created_at           | timestamp   | Creation timestamp                               |
| related_id           | uuid        | Related entity ID                                |
| related_type         | text        | Related entity type                              |
| action_url           | text        | URL for notification action                      |

## Offline Sync

### sync_queue
Queue for offline changes to be synced.

| Column               | Type        | Description                                      |
|----------------------|-------------|--------------------------------------------------|
| id                   | uuid        | Primary key                                      |
| user_id              | uuid        | Foreign key to users.id                          |
| entity_type          | text        | Type of entity: transaction, account, etc.       |
| entity_id            | uuid        | Entity ID                                        |
| operation            | text        | Operation: create, update, delete                |
| entity_data          | jsonb       | Entity data                                      |
| created_at           | timestamp   | Creation timestamp                               |
| status               | text        | Status: pending, synced, failed                  |
| retry_count          | int         | Number of sync attempts                          |
| error_message        | text        | Error message if failed                          |
| sync_priority        | int         | Priority for syncing                             |

## Database Indexes

```sql
-- Example indexes for performance optimization
CREATE INDEX idx_transactions_workspace_date ON transactions(workspace_id, date);
CREATE INDEX idx_transactions_account_date ON transactions(account_id, date);
CREATE INDEX idx_transactions_category_date ON transactions(category_id, date);
CREATE INDEX idx_recurring_transactions_next_date ON recurring_transactions(next_date);
CREATE INDEX idx_budgets_workspace_period ON budgets(workspace_id, period);
CREATE INDEX idx_group_expenses_group_id ON group_expenses(group_id);
CREATE INDEX idx_debt_records_lender_borrower ON debt_records(lender_id, borrower_id);
CREATE INDEX idx_sync_queue_user_status ON sync_queue(user_id, status);
```

## Row-Level Security Policies

```sql
-- Example RLS policy for transactions
CREATE POLICY "Users can view their own workspace transactions" ON transactions
  FOR SELECT USING (
    workspace_id IN (
      SELECT workspace_id FROM workspace_members
      WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Users can insert their own workspace transactions" ON transactions
  FOR INSERT WITH CHECK (
    workspace_id IN (
      SELECT workspace_id FROM workspace_members
      WHERE user_id = auth.uid()
    )
  );

-- Similar policies would be created for all tables
```

## Supabase Functions

Several Edge Functions will be implemented in Supabase:

1. `recalculateAccountBalance` - Trigger to update account balances after transaction changes
2. `generateRecurringTransactions` - Scheduled function to create transactions from templates
3. `sendNotifications` - Process notification queue and send to FCM
4. `syncOfflineChanges` - Process sync queue for offline changes
5. `processGroupSettlement` - Calculate optimal debt settlement for groups

These functions will be documented separately in the [Supabase Functions](supabase_functions.md) file. 
